{% extends "sitio_publico/base.html" %}
{% load static %}
{% load roles %}

{% block content %}

<div class="container py-5">

    <h1 class="fw-bold mb-4 text-center">Mi Panel</h1>

    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">

            <!-- PANEL -->
            <div class="p-4 shadow"
                 style="border-radius: 16px; background: #fff;">

                <h4 class="fw-bold mb-3">
                    Hola, {{ user.first_name|default:user.username }}!
                </h4>

                <p class="text-muted">
                    Desde aquí podés consultar el estado de tu registro audiovisual
                    y acceder a las convocatorias disponibles.
                </p>

                <hr>

                <p><strong>Rol:</strong> {{ user|rol_usuario }}</p>

                {% if user|rol_usuario == "Administrador" %}
                    <a href="/admin/"
                       class="btn btn-dark w-100 mt-3">
                        Ir al panel de administración
                    </a>
                {% endif %}

                {# ===================================================== #}
                {# TODO LO SIGUIENTE SOLO PARA NO ADMINISTRADORES       #}
                {# ===================================================== #}
                {% if user|rol_usuario != "Administrador" %}

                <hr>

                <!-- ESTADO DEL REGISTRO -->
                {% if persona_humana or persona_juridica %}
                    <p class="mb-2">
                        <strong>Estado del registro audiovisual:</strong>
                        <span class="badge bg-success ms-2">Completado</span>
                    </p>

                    {% if persona_humana %}
                        <p class="text-muted small mb-1">
                            Registrado como <strong>Persona Humana</strong>.
                        </p>
                    {% endif %}

                    {% if persona_juridica %}
                        <p class="text-muted small mb-1">
                            Registrado como <strong>Persona Jurídica</strong>.
                        </p>
                    {% endif %}
                {% else %}
                    <p class="mb-2">
                        <strong>Estado del registro audiovisual:</strong>
                        <span class="badge bg-warning text-dark ms-2">
                            Pendiente
                        </span>
                    </p>
                {% endif %}

                <hr>

                <!-- MIS CONVOCATORIAS -->
                <p class="mb-3"><strong>Mis convocatorias:</strong></p>

                {# ======================= #}
                {# POSTULACIONES (IDEA)    #}
                {# ======================= #}
                {% if postulaciones %}
                    {% for p in postulaciones %}
                        <p class="mb-2">
                            <strong>
                              {% if p.convocatoria %}
                                <a href="{% url 'convocatorias:convocatoria_detalle' p.convocatoria.slug %}">
                                  {{ p.convocatoria.titulo }}
                                </a>
                              {% else %}
                                Convocatoria eliminada
                              {% endif %}
                            </strong><br>

                            <span class="text-muted small">
                                Proyecto: <strong>{{ p.nombre_proyecto|default:"(Sin título)" }}</strong>
                            </span>

                            <span class="badge ms-2
                                {% if p.estado == 'enviado' %}
                                    bg-secondary
                                {% elif p.estado == 'revision_admin' %}
                                    bg-info
                                {% elif p.estado == 'observado' %}
                                    bg-warning text-dark
                                {% elif p.estado == 'admitido' %}
                                    bg-primary
                                {% elif p.estado == 'evaluacion_jurado' %}
                                    bg-primary
                                {% elif p.estado == 'seleccionado' %}
                                    bg-success
                                {% elif p.estado == 'no_seleccionado' %}
                                    bg-danger
                                {% elif p.estado == 'finalizado' %}
                                    bg-success
                                {% else %}
                                    bg-secondary
                                {% endif %}
                            ">
                                {{ p.get_estado_display }}
                            </span>
                        </p>

                        {# ============================= #}
                        {# OBSERVACIONES / SUBSANACIÓN  #}
                        {# ============================= #}
                        {% if p.estado == "observado" %}
                            <div class="alert alert-warning mt-3">
                                <h6 class="fw-bold mb-2">
                                    Observaciones pendientes
                                </h6>

                                <ul class="mb-2">
                                    {% for obs in p.observaciones.all %}
                                        {% if not obs.subsanada %}
                                            <li>
                                                <strong>{{ obs.get_tipo_documento_display }}:</strong>
                                                {{ obs.descripcion }}
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>

                                <a href="{% url 'convocatorias:subir_documento_subsanado' p.id %}"
                                   class="btn btn-warning btn-sm mt-2">
                                    Subir documentación solicitada
                                </a>
                            </div>
                        {% endif %}

                        <hr>
                    {% endfor %}
                {% endif %}

                {# ======================= #}
                {# RENDICIONES             #}
                {# ======================= #}
                {% if rendiciones %}
                    <p class="mb-3"><strong>Rendiciones:</strong></p>

                    {% for r in rendiciones %}
                        <p class="mb-2">
                            <strong>
                                {{ r.postulacion.convocatoria.titulo }}
                            </strong><br>

                            <span class="text-muted small">
                                Proyecto:
                                <strong>{{ r.postulacion.nombre_proyecto|default:"(Sin título)" }}</strong>
                            </span>

                            <span class="badge ms-2
                                {% if r.estado == 'BORRADOR' %}
                                    bg-secondary
                                {% elif r.estado == 'ENVIADO' %}
                                    bg-info
                                {% elif r.estado == 'OBSERVADO' %}
                                    bg-warning text-dark
                                {% elif r.estado == 'SUBSANADO' %}
                                    bg-primary
                                {% elif r.estado == 'APROBADO' %}
                                    bg-success
                                {% elif r.estado == 'RECHAZADO' %}
                                    bg-danger
                                {% else %}
                                    bg-secondary
                                {% endif %}
                            ">
                                {{ r.get_estado_display }}
                            </span>
                        </p>

                        {% if r.observaciones_admin and r.estado == "OBSERVADO" %}
                            <div class="alert alert-warning mt-2">
                                <strong>Observación:</strong><br>
                                {{ r.observaciones_admin }}
                            </div>
                        {% endif %}

                        <p class="mb-2">
                            {% if r.link_documentacion %}
                                <a href="{{ r.link_documentacion }}"
                                   target="_blank"
                                   rel="noopener"
                                   class="btn btn-outline-primary btn-sm">
                                    Ver link de rendición
                                </a>
                            {% else %}
                                <span class="text-muted small">
                                    Aún no cargaste el link de rendición.
                                </span>
                            {% endif %}
                        </p>

                        <a href="{% url 'convocatorias:rendicion_detalle' r.id %}"
                           class="btn btn-primary btn-sm mb-3">
                            {% if r.estado == "OBSERVADO" %}
                                Corregir rendición
                            {% else %}
                                Ver / completar rendición
                            {% endif %}
                        </a>

                        <hr>
                    {% endfor %}
                {% endif %}

                {# ======================= #}
                {# FORMACIÓN (INSCRIPCIONES) #}
                {# ======================= #}
                {% if inscripciones_formacion %}
                    <div class="mt-2">
                        <p class="mb-2"><strong>Formación:</strong></p>

                        {% for ins in inscripciones_formacion %}
                            <p class="mb-2">
                                <strong>
                                  {% if ins.convocatoria %}
                                    <a href="{% url 'convocatorias:convocatoria_detalle' ins.convocatoria.slug %}">
                                      {{ ins.convocatoria.titulo }}
                                    </a>
                                  {% else %}
                                    Convocatoria eliminada
                                  {% endif %}
                                </strong>

                                <span class="badge ms-2
                                    {% if ins.estado == 'inscripto' %}
                                        bg-secondary
                                    {% elif ins.estado == 'admitido' %}
                                        bg-success
                                    {% elif ins.estado == 'no_admitido' %}
                                        bg-danger
                                    {% elif ins.estado == 'lista_espera' %}
                                        bg-warning text-dark
                                    {% else %}
                                        bg-secondary
                                    {% endif %}
                                ">
                                    {{ ins.get_estado_display }}
                                </span>
                            </p>
                        {% endfor %}
                    </div>

                    <hr>
                {% endif %}

                {# ======================= #}
                {# EXENCIÓN (SUBSANACIÓN)  #}
                {# ======================= #}
                {% if exencion_observaciones_pendientes %}
                <div class="alert alert-warning mt-3">
                    <h6 class="fw-bold mb-2">
                    Observaciones pendientes (Exención)
                    </h6>

                    <ul class="mb-2">
                    {% for obsx in exencion_observaciones_pendientes %}
                        <li>
                        <strong>{{ obsx.get_tipo_documento_display }}:</strong>
                        {{ obsx.descripcion }}
                        </li>
                    {% endfor %}
                    </ul>

                    {% if exencion %}
                    <a href="{% url 'exencion:subir_documento_subsanado_exencion' exencion.id %}"
                        class="btn btn-warning btn-sm mt-2">
                        Subir documentación solicitada (Exención)
                    </a>
                    {% endif %}
                </div>

                <hr>
                {% endif %}

                {# Si no hay nada, mensaje único #}
                {% if not postulaciones and not inscripciones_formacion and not exencion %}
                <p class="text-muted small">
                    No participaste en ninguna convocatoria.
                </p>
                <hr>
                {% endif %}

                <!-- ACCIONES -->
                <div class="d-grid gap-3 mt-4">

                    {% if persona_humana %}
                        <a href="{% url 'registro_audiovisual:editar_persona_humana' %}"
                           class="btn btn-primary">
                            Editar mis datos (Persona Humana)
                        </a>
                    {% endif %}

                    {% if persona_juridica %}
                        <a href="{% url 'registro_audiovisual:editar_persona_juridica' %}"
                           class="btn btn-primary">
                            Editar mis datos (Persona Jurídica)
                        </a>
                    {% endif %}

                    {% if not persona_humana and not persona_juridica %}
                        <a href="{% url 'registro_audiovisual:seleccionar_tipo_registro' %}"
                           class="btn btn-warning">
                            Completar Registro Audiovisual
                        </a>
                    {% endif %}

                    <a href="{% url 'convocatorias:convocatorias_home' %}"
                       class="btn btn-outline-primary">
                        Ver Convocatorias Disponibles
                    </a>

                    {% if exencion %}
                        {% if exencion.certificado_pdf %}
                            <a href="{{ exencion.certificado_pdf.url }}"
                               class="btn btn-info"
                               download>
                                Descargar constancia de exención impositiva
                            </a>
                        {% else %}
                            <button class="btn btn-outline-secondary" disabled>
                                Exención impositiva en revisión
                            </button>
                        {% endif %}
                    {% endif %}

                </div>

                {% endif %} {# /no administrador #}

                <a href="{% url 'usuarios:logout' %}"
                   class="btn btn-outline-danger mt-4 w-100">
                    Cerrar sesión
                </a>

            </div>
            <!-- /PANEL -->

        </div>
    </div>
</div>

{% endblock %}
